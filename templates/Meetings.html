{% extends "layout.html" %}

{% block stylesheet %}
<style>
.daybutton {
  font-weight: 400;
  width: 2.5rem;
  height: 2.5rem;
  padding: 0rem 0rem;
}
.daybutton.next {
  border-color: #007bff;
  border-width: 3px;
}
.daybutton:not(:disabled) {
  background-color: rgb(180, 180, 180);
  
}
.daybutton:disabled {
  background-color: rgb(221, 221, 221);
  opacity:100%;
  color: black;
}
.trigger.next {
  font-weight: 1000;
}
.arr {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  width: 15px;
  height: 15px;
}
.arr-up {
  transform: rotate(-135deg);
  -webkit-transform: rotate(-135deg);
}
.arr-down {
  transform: rotate(45deg);
  -webkit-transform: rotate(45deg);
}
.arr-disabled {
  opacity: 20%;
}
.list-group-item-light {
  color: #000000;
}
.list-group-item-light.list-group-item-action:hover, .list-group-item-light.list-group-item-action:focus {
  color: #000000;
}
.list-group-item-light.list-group-item-action.active {
  color: #ffffff;
  background-color: #9e9e9e;
  border-color: #9e9e9e;
}
.actuallynofade{
  transition: none;
}
</style>
{% endblock stylesheet %}

{% block content %}
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th scope="col">Status</th>
        <th scope="col">Name</th>
        <th scope="col">Link</th>
        <th scope="col">Run Times</th>
        <th scope="col">Next Run Time</th>
        <th scope="col">Options</th>
      </tr>
    </thead>
    <tbody>
        {% for meeting in meetings.values() %}
            <tr>
                <td>
                  <div>
                    {% if meeting.enabled %}
                    <input type="checkbox" class="checkbox" name="enabled" id="chk{{loop.index}}" onclick="post_to('change_state','{{ meeting.id }}')">
                    {% else %}
                    <input type="checkbox" class="checkbox" name="enabled" id="chk{{loop.index}}" onclick="post_to('change_state','{{ meeting.id }}')" checked>
                    {% endif %}
                    <label class="label" for="chk{{loop.index}}">
                        <div class="ball"></div>
                    </label>
                  </div>
                </td>
                <td>{{ meeting.name }}</td>
                <td class="text">
                  <span id="link">{{ meeting.browser_link() }}</span>
                  <a class="copy-link" href="#" onclick="copylink('{{meeting.browser_link()}}')">Copy Link</a>
                </td>
                <td>
                  {% for trigger in meeting.triggers %}
                      Every {{ trigger.formatted_day_time() }}
                      <br>
                  {% endfor %}
                </td>
                <td>{{ meeting.formatted_next_run() }}</td>
                <td class="centered">
                  <a class="btn btn-primary btn-sm option-button" href="{{ url_for('run_task', id=meeting.id) }}">Run Now</a>
                  <br>
                  <a class="btn btn-primary btn-sm option-button" href="{{ url_for('edit_task', id=meeting.id) }}">Edit</a>
                  <br>
                  <a class="btn btn-danger btn-sm option-button" href="{{ url_for('delete_task', id=meeting.id) }}">Delete</a>
                </td>
            </tr>
        {% endfor %}
    </tbody>
  </table>
  <table class="table table-striped meetinglist">
    <thead>
      <tr>
        <th scope="col">Meetings</th>
      </tr>
    </thead>
    <tbody>
      {% for meeting in meetings.values() %}
        <tr>
          <td>
            <i class="arr arr-up arr-disabled" id="up{{loop.index}}" data-index={{loop.index}}></i>
            <br>
            <i class="arr arr-down arr-disabled" id="down{{loop.index}}" data-index={{loop.index}}></i>
            </td>
          <td class="centered">
            <!--<a class="btn btn-primary btn-sm option-button" href="{{ url_for('run_task', id=meeting.id) }}">Run Now</a>-->
            <a href="{{ url_for('run_task', id=meeting.id) }}">
              <svg height="40" width="40">
                <polygon points="4,4 4,36 36,20" style="fill:green;stroke-width:3"/>
              </svg>
            </a>
          </td>
          <td>{{ meeting.name }}</td>
          <td class="text">
            {% for i in range(7) %}
              <button type="button" class="btn daybutton{{' next' if meeting.triggers_by_day()[(i-1)%7][1] }}" data-toggle="popover" title="{{meeting.triggers_by_day()[(i-1)%7][0]}}" {{"disabled" if not meeting.triggers_by_day()[(i-1)%7][2]}}>
                {{meeting.triggers_by_day()[(i-1)%7][0][0]}}
              </button>
              <div id="popover_content_wrapper" style="display: none">
                {% for j in meeting.triggers_by_day()[(i-1)%7][2] %}
                  <div class="trigger{{' next' if j[0]}}">{{j[1]}}</div>
                {% endfor %}
              </div>
            {% endfor %}
          <td class="centered">
            <button class="btn btn-primary btn-sm option-button" id="edit{{ meeting.id }}" data-toggle="modal" data-target="#edit_task_modal">Edit</button>
          </td>
          <td>
            <div>
              {% if meeting.enabled %}
              <input type="checkbox" class="checkbox" name="enabled" id="chk{{loop.index}}" onclick="post_to('change_state','{{ meeting.id }}')">
              {% else %}
              <input type="checkbox" class="checkbox" name="enabled" id="chk{{loop.index}}" onclick="post_to('change_state','{{ meeting.id }}')" checked>
              {% endif %}
              <label class="label" for="chk{{loop.index}}">
                  <div class="ball"></div>
              </label>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

{% endblock content %}

{% block modal %}
<div class="modal fade" id="edit_task_modal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="edit_task_modal_title">Edit Meeting</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="edit_task_form">
          <div class="form-group">
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text" style="width: 4rem">Name</span>
              </div>
              <input type="text" class="form-control" id="meeting_name" name="meeting_name">
            </div>
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text" style="width: 4rem">Link</span>
              </div>
              <input type="text" class="form-control" id="meeting_link" name="meeting_link" pattern="{{ linkre }}" oninvalid="setCustomValidity('Invalid Zoom link')">
            </div>
          </div>
          <div class="form-group">
            <label for="triggers" class="col-form-label">Run Times: </label>
            <div class="row">
              <div class="col-4">
                <div class="list-group" id="days-list-tab" role="tablist">
                </div>
                <a class="list-group-item list-group-item-action list-group-item-light" id="day-template" data-toggle="list" role="tab" style="display: none"></a>
                <span class="badge badge-primary badge-pill" id="pill-template" style="float: right"></span>
              </div>
              <div class="col-4">
                <div class="tab-content" id="day-content">
                </div>
                <div class="tab-pane fade actuallynofade" id="list-template" role="tabpanel">
                  <div id="addtrigger">
                    <div class="input-group mb-2">
                      <input type="time" id="newtrigger">
                      <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" id="addtrigger-button">+</button>
                      </div>
                    </div>
                  </div>
                  <hr>
                </div>
                <div id="time-template" style="display: none">
                  <div class="input-group mb-2">
                    <input type="time">
                    <div class="input-group-append">
                        <button class="btn btn-outline-danger" type="button" id="deletetrigger-button">âˆ’</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button class="btn btn-primary" id="submit-form">Save Changes</button>
            <!--<input type="submit" class="btn btn-primary" name="submit" id="submit-form" value="Save Changes">-->
          </div>
          <input type="hidden" name="trigger-data" id="trigger-data">
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock modal %}

{% block script %}
<script>
  const daynames = new Map([[6, "Sunday"], [0, "Monday"], [1, "Tuesday"], [2, "Wednesday"], [3, "Thursday"], [4, "Friday"], [5, "Saturday"]])
  
  

  $(function(){
    
    $('.daybutton:not(.disabled)').popover({
      html : true,
      trigger: 'focus',
      placement: 'bottom',
      content: function() {
        return $(this).next('#popover_content_wrapper').html()
      }
    })
    {% for meeting in meetings.values() %}
      $('#up{{loop.index}}').click(function(){
        if (!($(this).hasClass('arr-disabled'))) {
          let index = $(this).attr('data-index')
          shift_task('{{meeting.id}}', index, -1)
          refresh()
        }
      })
      $('#down{{loop.index}}').click(function(){
        if (!($(this).hasClass('arr-disabled'))) {
          let index = $(this).attr('data-index')
          shift_task('{{meeting.id}}', index, 1)
          refresh()
        }
      })
    {% endfor %}
    $('arr-disabled').off('click')
    refresh()
    
    set_edit_data()

    /*show modal*/
    $('#edit_task_modal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget)
      var id = button.data('id')
      var meetingname = button.data('name')
      var meetinglink = button.data('link')
      var modal = $(this)
      var triggers = modal.find('#trigger-data').data(button.data('triggers')).data()

      /*modal.find('#edit_task_form').attr('action', '/'+id+'/edit_task')*/
      modal.find('.modal-title').text('Edit Meeting: ' + meetingname)
      modal.find('.modal-body #meeting_link').val(meetinglink)
      modal.find('.modal-body #meeting_name').val(meetingname)
      modal.find('#submit-form').attr('action', '/'+id+'/edit_task')

      function getlist(day) {
        //console.log(day)
        var list = $(document.createElement('div'))
        //console.log(list.attr("id"))
        for ([i, trigger] of triggers[day[0]][2].entries()) {
          //console.log(trigger[2])
          timetemplate = modal.find("#time-template")
          time = timetemplate.clone()
          time.attr("id", "trigger-wrapper-"+i)
          time.find("input").attr("value", trigger[2])
          time.find("#deletetrigger-button").attr("id", "deletetrigger-button-"+i)
          time.removeAttr('style')
          list.append(time)
        }
        return list
      }

      function updatepills() {
        $('[id^=pill-]').filter( function() {
        return !(parseInt($(this).text()) > 0)
      }).css('display', 'none')
      }
      
      for (day of daynames) {
        //day names
        var daytemplate = modal.find("#day-template")
        var day_item = daytemplate.clone()
        day_item.attr("id", "list-"+day[1]+"-list")
        day_item.attr("href", "#list-"+day[1])
        day_item.css("display", "block")
        day_item.text(day[1])

        pill = modal.find("#pill-template").clone()
        pill.attr('id', 'pill-'+day[1])
        pill.text(triggers[day[0]][2].length)
        day_item.append(pill)

        $("#days-list-tab").append(day_item)


        list = modal.find("#list-template").clone()
        list.attr("id", "list-"+day[1])
        list.append(getlist(day).children())

        addbutton = list.find('#addtrigger-button')
        addbutton.attr('id', "addtrigger-button-"+day[1])
        addbutton.data('day', day)
        addbutton.data('triggers', triggers[day[0]])
        addbutton.on('click', function(event) {
          day = $(this).data('day')
          newtrigger = modal.find('#list-'+day[1]).find('#newtrigger').val()
          if (!newtrigger) {
            console.log('finishing entering stuff pls')
            return
          }
          triggers[day[0]][2].push([null, null, newtrigger])
          console.log(triggers[day[0]][2])
          triggers[day[0]][2].sort(function (a, b) {
            return new Date('1970/01/01 ' + a[2]) - new Date('1970/01/01 ' + b[2]);
          });
          //refresh list
          modal.find('#pill-'+day[1]).text(triggers[day[0]][2].length)
          updatepills()
          modal.find('#day-content #list-'+day[1]+' [id^=trigger-wrapper]').remove()
          modal.find('#day-content #list-'+day[1]).append(getlist(day).children())
          return
        })
        //console.log(addbutton.data())
        modal.find('#day-content').append(list)
      }
      updatepills()
    })
    $('#edit_task_modal').on('hidden.bs.modal', function () {
      var modal = $(this)
      modal.find('#day-content').html('')
      modal.find("#days-list-tab").html('')
      //$(".list-group-item").removeClass('active')
    })
  })

  $("#addtrigger-button").click( function() {
    
  })
  
  
  function update_trigger_data() {

  }

  function htmlDecode(input){
    var e = document.createElement('textarea')
    e.innerHTML = input
    // handle case of empty input
    return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue
  }

  function post_to(link, id){
    $.post(`/${id}/${link}`)
    console.log(`/${id}/${link}`)
    return false
  }

  function copylink(link) {
    const el = document.createElement('textarea')
    el.value = link
    document.body.appendChild(el)
    el.select()
    document.execCommand('copy')
    document.body.removeChild(el)
  }

  function shift_task(id, index, direction) {
    $.post(`/${id}/shift_task/${direction}`)
    console.log(`/${id}/shift_task/${direction}`)
    other = parseInt(index)+parseInt(direction)
    console.log(other)
    let replacetr = $("tr").has("i[data-index="+ other +"]")
    let replace = $("i[data-index="+ other +"]")
    let movetr = $("tr").has("i[data-index="+ index +"]")
    let move = $("i[data-index="+ index +"]")
    if (direction > 0) {
      movetr.insertAfter(replacetr)
    } else if (direction < 0) {
      movetr.insertBefore(replacetr)
    }
    replace.attr('data-index', index)
    move.attr('data-index', other)
  }

  function refresh() {
    _top = $('[id^="up"][data-index=1]')
    nottop = $('[id^="up"]:not([data-index=1])')
    bottom = $('[id^="down"][data-index={{meetings|length}}]')
    notbottom = $('[id^="down"]:not([data-index={{meetings|length}}])')
    _top.addClass('arr-disabled')
    bottom.addClass('arr-disabled')
    nottop.removeClass('arr-disabled')
    notbottom.removeClass('arr-disabled')
  }

  function set_edit_data() {
    var meetingArray = new Array()
    var meeting = {}
    {% for meeting in meetings.values() %}
      meeting = {id: '{{meeting.id}}', name: '{{meeting.name}}', link: htmlDecode('{{meeting.browser_link()}}'), triggers: {{meeting.triggers_by_day() | tojson}}}
      meetingArray.push(meeting)
    {% endfor %}
    for (var i = 0; i < meetingArray.length; i++){
      $('#edit'+meetingArray[i].id).data(meetingArray[i])
    }
  }
</script>
{% endblock script %}