{% extends "layout.html" %}

{% block stylesheet %}
<style>
.daybutton {
  font-weight: 400;
  width: 2.5rem;
  height: 2.5rem;
  padding: 0rem 0rem;
}
.daybutton.next {
  border-color: #007bff;
  border-width: 3px;
}
.daybutton.on {
  background-color: rgb(180, 180, 180);
}
.daybutton.off {
  background-color: rgb(221, 221, 221);
}
</style>
{% endblock stylesheet %}

{% block content %}
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th scope="col">Status</th>
        <th scope="col">Name</th>
        <th scope="col">Link</th>
        <th scope="col">Run Times</th>
        <th scope="col">Next Run Time</th>
        <th scope="col">Options</th>
      </tr>
    </thead>
    <tbody>
        {% for meeting in meetings.values() %}
            <tr>
                <td>
                  <div>
                    {% if meeting.enabled %}
                    <input type="checkbox" class="checkbox" name="enabled" id="chk{{loop.index}}" onclick="change_state('{{ meeting.id }}')">
                    {% else %}
                    <input type="checkbox" class="checkbox" name="enabled" id="chk{{loop.index}}" onclick="change_state('{{ meeting.id }}')" checked>
                    {% endif %}
                    <label class="label" for="chk{{loop.index}}">
                        <div class="ball"></div>
                    </label>
                  </div>
                </td>
                <td>{{ meeting.name }}</td>
                <td class="text">
                  <span id="link">{{ meeting.browser_link() }}</span>
                  <a class="copy-link" href="#" onclick="copylink('{{meeting.browser_link()}}')">Copy Link</a>
                </td>
                <td>
                  {% for trigger in meeting.triggers %}
                      Every {{ trigger.formatted_day_time() }}
                      <br>
                  {% endfor %}
                </td>
                <td>{{ meeting.formatted_next_run() }}</td>
                <td class="centered">
                  <a class="btn btn-primary btn-sm option-button" href="{{ url_for('run_task', id=meeting.id) }}">Run Now</a>
                  <br>
                  <a class="btn btn-primary btn-sm option-button" href="{{ url_for('edit_task', id=meeting.id) }}">Edit</a>
                  <br>
                  <a class="btn btn-danger btn-sm option-button" href="{{ url_for('delete_task', id=meeting.id) }}">Delete</a>
                </td>
            </tr>
        {% endfor %}
    </tbody>
  </table>
  <table class="table table-striped">
    <thead>
      <tr>
        <th scope="col">Meetings</th>
      </tr>
    </thead>
    <tbody>
      {% for meeting in meetings.values() %}
        <tr>
          <td class="centered">
            <!--<a class="btn btn-primary btn-sm option-button" href="{{ url_for('run_task', id=meeting.id) }}">Run Now</a>-->
            <a href="{{ url_for('run_task', id=meeting.id) }}">
              <svg height="40" width="40">
                <polygon points="4,4 4,36 36,20" style="fill:green;stroke-width:3"/>
              </svg>
            </a>
          </td>
          <td>{{ meeting.name }}</td>
          <td class="text">
            {% for i in range(7) %}
              <button type="button" class="btn daybutton{{' next' if meeting.triggers_by_day()[(i-1)%7][1] }}{{' on' if meeting.triggers_by_day()[(i-1)%7][2] else ' off'}}" data-toggle="popover" title="{{meeting.triggers_by_day()[(i-1)%7][0]}}">
                {{meeting.triggers_by_day()[(i-1)%7][0][0]}}
              </button>
              <div id="popover_content_wrapper" style="display: none">
                {% for j in meeting.triggers_by_day()[(i-1)%7][2] %}
                  <div>{{j[1]}}</div>
                {% endfor %}
              </div>
            {% endfor %}
          <!--<td class="centered">
            <a class="btn btn-primary btn-sm option-button" href="{{ url_for('edit_task', id=meeting.id) }}">Edit</a>
            <br>
            <a class="btn btn-daybutton btn-sm option-button" href="{{ url_for('delete_task', id=meeting.id) }}">Delete</a>
          </td>-->
          <td>
            <div>
              {% if meeting.enabled %}
              <input type="checkbox" class="checkbox" name="enabled" id="chk{{loop.index}}" onclick="change_state('{{ meeting.id }}')">
              {% else %}
              <input type="checkbox" class="checkbox" name="enabled" id="chk{{loop.index}}" onclick="change_state('{{ meeting.id }}')" checked>
              {% endif %}
              <label class="label" for="chk{{loop.index}}">
                  <div class="ball"></div>
              </label>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

{% endblock content %}

{% block script %}
<script>
  var script = document.createElement('script');
  script.src = 'https://code.jquery.com/jquery-3.4.1.min.js';
  script.type = 'text/javascript';
  document.getElementsByTagName('head')[0].appendChild(script);

$(function(){
  $('.daybutton').popover({
    html : true,
    trigger: 'focus',
    placement: 'bottom',
    content: function() {
      return $(this).next('#popover_content_wrapper').html();
    }
  })
})

  function change_state(id){
    $.post(`/${id}/change_state`);
    return false;
  }
  function copylink(link) {
    const el = document.createElement('textarea');
    el.value = link;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
  }
</script>
{% endblock script %}